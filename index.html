<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LISBOA PRO ULTRA - FINAL REVISADA</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #1b4a9c; --accent: #00b4ff; --success: #00ff9d; --danger: #ff4b2b; --warning: #f39c12; --dark: #0a192f; --card: #112240; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; padding-bottom: 70px; overflow-x: hidden; }
        .header-logo { text-align: center; padding: 15px; background: #112240; border-bottom: 3px solid var(--primary); }
        .main-logo { max-width: 140px; }
        .container { padding: 12px; max-width: 850px; margin: auto; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .menu-item { background: var(--card); padding: 15px 5px; border-radius: 15px; text-align: center; border: 1px solid var(--primary); cursor: pointer; position: relative; transition: 0.2s; }
        .menu-item:active { transform: scale(0.95); background: var(--primary); }
        .menu-item i { font-size: 1.5rem; color: var(--accent); margin-bottom: 5px; display: block; }
        .menu-item span { font-size: 0.65rem; font-weight: bold; text-transform: uppercase; display: block; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 7px; font-size: 11px; font-weight: bold; border: 2px solid var(--dark); }

        .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); display: none; }
        .active-section { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .box-destaque { background: linear-gradient(135deg, #1b4a9c, #00ff9d); color: #000; padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; font-weight: bold; }
        
        input, select, textarea { background: #0d1f33; border: 1px solid #1e3a5a; color: white; padding: 14px; border-radius: 10px; width: 100%; box-sizing: border-box; margin: 6px 0; font-size: 16px; }
        button { padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; width: 100%; margin: 6px 0; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-add { background: var(--success); color: #000; }
        .btn-blue { background: var(--primary); color: white; }
        .btn-del { background: var(--danger); color: white; }
        .btn-wpp { background: #25d366; color: white; }
        
        .item-lista { background: rgba(0,0,0,0.4); padding: 14px; border-radius: 12px; margin-top: 10px; border-left: 5px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .vencido { border-left-color: var(--danger); background: rgba(255, 75, 43, 0.1); }
    </style>
</head>
<body>

<div class="header-logo">
    <img src="B1BCC237-7C89-4142-8131-6DA05C2A2C61 2.png" alt="Oficina Lisboa" class="main-logo">
</div>

<div id="loginBox" class="container">
    <div class="card active-section" style="text-align: center;">
        <i class="fas fa-user-check" style="font-size: 2rem; color: var(--accent); margin-bottom: 10px;"></i>
        <h3>ACESSO LISBOA PRO</h3>
        <input id="pass" type="password" placeholder="Senha Administrativa">
        <button class="btn-blue" onclick="login()">ENTRAR NO SISTEMA</button>
    </div>
</div>

<div id="dashboard" class="container" style="display:none">
    
    <div class="menu-grid">
        <div class="menu-item" onclick="show('sec-dash')"><i class="fas fa-wallet"></i><span>Lucro</span></div>
        <div class="menu-item" onclick="show('sec-serv')"><i class="fas fa-motorcycle"></i><span>Servi√ßo</span></div>
        <div class="menu-item" onclick="show('sec-contas')"><i class="fas fa-money-bill-wave"></i><span>Contas</span></div>
        <div class="menu-item" onclick="show('sec-hist')"><i class="fas fa-history"></i><span>Busca</span></div>
        <div class="menu-item" onclick="show('sec-oleo')">
            <i class="fas fa-oil-can"></i><span>√ìleo</span>
            <span id="notif-oleo" class="badge" style="display:none">0</span>
        </div>
        <div class="menu-item" onclick="show('sec-estoque')"><i class="fas fa-box"></i><span>Estoque</span></div>
        <div class="menu-item" onclick="show('sec-precos')"><i class="fas fa-tags"></i><span>Tabela</span></div>
        <div class="menu-item" onclick="show('sec-calc')"><i class="fas fa-calculator"></i><span>Taxas</span></div>
        <div class="menu-item" onclick="show('sec-agenda')"><i class="fas fa-calendar-alt"></i><span>Agenda</span></div>
        <div class="menu-item" onclick="show('sec-compras')"><i class="fas fa-shopping-cart"></i><span>Compras</span></div>
        <div class="menu-item" onclick="show('sec-check')"><i class="fas fa-clipboard-list"></i><span>Avarias</span></div>
        <div class="menu-item" onclick="show('sec-ia')"><i class="fas fa-robot"></i><span>Gest√£o</span></div>
    </div>

    <div id="sec-dash" class="card">
        <div class="box-destaque">DINHEIRO LIMPO: <br><span id="d-lucro" style="font-size: 2rem;">R$ 0</span></div>
        <canvas id="graficoFin" height="150"></canvas>
        <button class="btn-blue" onclick="gerarPDF()"><i class="fas fa-file-pdf"></i> RELAT√ìRIO PDF</button>
        <button class="btn-del" onclick="fecharMes()" style="opacity: 0.5;">ZERAR M√äS</button>
    </div>

    <div id="sec-serv" class="card">
        <h3>üîß Novo Servi√ßo</h3>
        <input id="sNome" placeholder="Cliente">
        <input id="sPlaca" placeholder="Placa">
        <input id="sCel" placeholder="Zap (5511...)">
        <input id="sMao" type="number" placeholder="Sua M√£o de Obra R$">
        <input id="sPec" type="number" placeholder="Custo das Pe√ßas R$">
        <select id="sOleo">
            <option value="n√£o">Trocou √≥leo? N√£o</option>
            <option value="sim">Trocou √≥leo? Sim (Avisar em 90 dias)</option>
        </select>
        <button class="btn-add" onclick="addServico()">SALVAR SERVI√áO</button>
        <div style="display:flex; gap:5px">
            <button class="btn-blue" onclick="zapOrcamento()">OR√áAMENTO</button>
            <button class="btn-wpp" onclick="zapPronto()">AVISAR PRONTO</button>
        </div>
    </div>

    <div id="sec-contas" class="card">
        <h3>üí∏ Pagar Contas / Gastos</h3>
        <input id="ctN" placeholder="Ex: Luz, Aluguel, Almo√ßo">
        <input id="ctV" type="number" placeholder="Valor R$">
        <button class="btn-del" onclick="addConta()">PAGAR E DESCONTAR</button>
        <div id="list-contas"></div>
    </div>

    <div id="sec-oleo" class="card">
        <h3>üõ¢Ô∏è Retornos de Troca de √ìleo</h3>
        <div id="list-oleo"></div>
    </div>

    <div id="sec-hist" class="card"><h3>üìÇ Busca</h3><input id="busca" onkeyup="render()"><div id="list-hist"></div></div>
    <div id="sec-estoque" class="card"><h3>üì¶ Estoque</h3><input id="eN"><input id="eQ" type="number"><button onclick="addObj('estoque')">ADD</button><div id="list-estoque"></div></div>
    <div id="sec-precos" class="card"><h3>üìã Tabela</h3><input id="pN"><input id="pV"><button onclick="addObj('precos')">ADD</button><div id="list-precos"></div></div>
    <div id="sec-calc" class="card"><h3>üí≥ Taxas</h3><input id="calcV" type="number"><button onclick="alert('Cobrar: '+(calcV.value*1.12).toFixed(2))">CR√âDITO +12%</button></div>
    <div id="sec-agenda" class="card"><h3>üìÖ Agenda</h3><input id="agN"><input id="agD" type="date"><button onclick="addObj('agenda')">ADD</button><div id="list-agenda"></div></div>
    <div id="sec-compras" class="card"><h3>üõí Compras</h3><input id="cpI"><button onclick="addObj('compras')">ADD</button><div id="list-compras"></div></div>
    <div id="sec-check" class="card"><h3>üìã Check-list</h3><input id="avP" placeholder="Placa"><textarea id="avD"></textarea><button onclick="addObj('avarias')">SALVAR</button><div id="list-avarias"></div></div>
    <div id="sec-ia" class="card"><h3>ü§ñ Backup</h3><button onclick="gerarBack()">GERAR C√ìDIGO</button><textarea id="txtBack" style="font-size:8px"></textarea></div>

</div>

<script>
    let db = JSON.parse(localStorage.getItem('lisboa_ultra_v30_rev')) || { mao: 0, pecas_total: 0, contas_total: 0, hist: [], estoque: [], precos: [], agenda: [], compras: [], avarias: [], contas: [] };
    let chart;

    function save() { localStorage.setItem('lisboa_ultra_v30_rev', JSON.stringify(db)); render(); }
    function login() { if(pass.value === "1234") { loginBox.style.display='none'; dashboard.style.display='block'; show('sec-dash'); render(); } }
    function show(id) { document.querySelectorAll('.card').forEach(c => c.classList.remove('active-section')); document.getElementById(id).classList.add('active-section'); window.scrollTo(0,0); }

    function addServico() {
        let m = parseFloat(sMao.value) || 0; let p = parseFloat(sPec.value) || 0;
        if(m+p > 0) {
            db.mao += m; db.pecas_total += p;
            db.hist.unshift({n: sNome.value, p: sPlaca.value.toUpperCase(), v: (m+p), z: sCel.value, mao: m, pec: p, oleo: sOleo.value, data: new Date().getTime()});
            sMao.value=""; sPec.value=""; sNome.value=""; save(); alert("Servi√ßo Salvo!");
        }
    }

    function addConta() {
        let v = parseFloat(ctV.value) || 0;
        if(v > 0) { db.contas_total += v; db.contas.unshift({n: ctN.value, v: v}); ctN.value=""; ctV.value=""; save(); }
    }

    function addObj(t) {
        if(t==='estoque') db.estoque.push({n: eN.value, v: eQ.value});
        if(t==='precos') db.precos.push({n: pN.value, v: pV.value});
        if(t==='agenda') db.agenda.push({n: agN.value, d: agD.value});
        if(t==='compras') db.compras.push({n: cpI.value});
        if(t==='avarias') db.avarias.push({p: avP.value, d: avD.value});
        save();
    }

    function render() {
        let lucro = db.mao - db.contas_total;
        document.getElementById("d-lucro").innerText = "R$ " + lucro.toFixed(2);
        
        // Alerta √ìleo
        let venci = 0; let htmlOleo = "";
        db.hist.forEach(h => {
            if(h.oleo === "sim") {
                let dias = Math.floor((new Date().getTime() - h.data) / (1000*60*60*24));
                if(dias >= 90) {
                    venci++;
                    htmlOleo += `<div class="item-lista vencido"><span><b>${h.p}</b> - ${h.n}<br>(${dias} dias)</span><button class="btn-wpp" style="width:auto" onclick="window.open('https://api.whatsapp.com/send?phone=${h.z}&text=Ol√°! J√° faz ${dias} dias da sua troca de √≥leo. Vamos agendar?')">ZAP</button></div>`;
                }
            }
        });
        document.getElementById("notif-oleo").innerText = venci;
        document.getElementById("notif-oleo").style.display = venci > 0 ? "block" : "none";
        document.getElementById("list-oleo").innerHTML = htmlOleo || "Nenhum retorno hoje.";

        document.getElementById("list-contas").innerHTML = db.contas.map(c => `<div class="item-lista"><span>${c.n}</span><b style="color:red">- R$ ${c.v}</b></div>`).join('');
        document.getElementById("list-hist").innerHTML = db.hist.filter(h => h.p.includes(busca.value.toUpperCase())).map(h => `<div class="item-lista"><span><b>${h.p}</b> - ${h.n}</span><b>R$ ${h.v}</b></div>`).join('');

        const ctx = document.getElementById('graficoFin').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Meu Lucro', 'Pe√ßas', 'Contas'], datasets: [{ data: [lucro, db.pecas_total, db.contas_total], backgroundColor: ['#00ff9d', '#f39c12', '#ff4b2b'] }] } });
    }

    function gerarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("FECHAMENTO OFICINA LISBOA", 10, 10);
        doc.text("M√£o de Obra: R$ " + db.mao.toFixed(2), 10, 30);
        doc.text("Pe√ßas: R$ " + db.pecas_total.toFixed(2), 10, 40);
        doc.text("Contas: R$ " + db.contas_total.toFixed(2), 10, 50);
        doc.text("LUCRO REAL: R$ " + (db.mao - db.contas_total).toFixed(2), 10, 70);
        doc.save("financeiro_lisboa.pdf");
    }

    function zapOrcamento() { window.open(`https://api.whatsapp.com/send?phone=${sCel.value}&text=Or√ßamento: M√£o de Obra R$ ${sMao.value}, Pe√ßas R$ ${sPec.value}. Total R$ ${parseFloat(sMao.value)+parseFloat(sPec.value)}`); }
    function zapPronto() { window.open(`https://api.whatsapp.com/send?phone=${sCel.value}&text=Sua moto est√° pronta! Valor: R$ ${parseFloat(sMao.value)+parseFloat(sPec.value)}`); }
    function fecharMes() { if(confirm("Zerar gr√°fico?")) { db.mao=0; db.pecas_total=0; db.contas_total=0; save(); } }
    function gerarBack() { txtBack.value = btoa(JSON.stringify(db)); }
</script>
</body>
</html>
