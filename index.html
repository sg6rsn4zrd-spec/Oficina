<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LISBOA PRO MASTER FINAL</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
    --bg:#0a0e17; --card:#161b28; --primary:#2a5ee8; --accent:#00d2ff;
    --success:#00f298; --danger:#ff4b5c; --text:#e1e8f0; --warn:#ffb800;
}
body {margin:0; font-family:'Inter', sans-serif; background:var(--bg); color:var(--text);}
.header{background:var(--card); padding:20px; text-align:center; border-bottom:1px solid rgba(255,255,255,0.1);}
.header img{max-width:130px;}
.container{padding:15px; max-width:600px; margin:auto;}
.balance-card{background:linear-gradient(135deg,#1e2a4a,#161b28); padding:25px; border-radius:24px; text-align:center; margin-bottom:20px; border:1px solid rgba(255,255,255,0.1); box-shadow:0 10px 30px rgba(0,0,0,0.3);}
.balance-card h2{margin:0; font-size:0.8rem; text-transform:uppercase; opacity:0.7;}
.balance-val{font-size:2.5rem; font-weight:800; color:var(--success); margin:10px 0;}
.menu-grid{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:25px;}
.menu-item{background:var(--card); padding:12px 5px; border-radius:16px; text-align:center; border:1px solid rgba(255,255,255,0.05); cursor:pointer; transition:0.2s;}
.menu-item i{font-size:1.2rem; color:var(--accent); margin-bottom:6px; display:block;}
.menu-item span{font-size:0.55rem; font-weight:700; text-transform:uppercase;}
.menu-item:active{transform:scale(0.9); background:var(--primary);}
.section{background:var(--card); padding:20px; border-radius:24px; display:none; border:1px solid rgba(255,255,255,0.05);}
.active{display:block; animation:slideIn 0.3s ease-out;}
@keyframes slideIn{from{opacity:0; transform:translateY(10px);}to{opacity:1; transform:translateY(0);}}
input, select, textarea{background:#0f141e; border:1px solid #2d364a; color:white; padding:14px; border-radius:12px; width:100%; box-sizing:border-box; margin:8px 0; font-size:15px;}
button{background:var(--primary); color:white; padding:16px; border-radius:14px; border:none; font-weight:700; width:100%; cursor:pointer; margin-top:10px; font-size:14px; transition:0.2s;}
button:active{opacity:0.8;}
.btn-success{background:var(--success); color:#0a0e17;}
.btn-danger{background:var(--danger);}
.list-item{background: rgba(255,255,255,0.03); padding:15px; border-radius:16px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-left:4px solid var(--primary);}
.badge{background: var(--danger); color:white; border-radius:50px; padding:2px 8px; font-size:10px; position:absolute; top:-5px; right:-5px;}
.ia-box{background:#000; border:1px solid var(--success); padding:15px; border-radius:12px; font-family:'Courier New', monospace; color:var(--success); font-size:13px; line-height:1.4;}
/* ALERTAS POP-UP */
.pop-alert{position:fixed; top:20px; right:20px; padding:15px 20px; border-radius:12px; font-weight:700; color:#000; display:none; z-index:999;}
.pop-success{background:var(--success);}
.pop-warn{background:var(--warn);}
.pop-danger{background:var(--danger);}
</style>
</head>
<body>
<div class="pop-alert" id="popAlert"></div>

<div class="header">
    <img src="B1BCC237-7C89-4142-8131-6DA05C2A2C61 2.png" alt="Lisboa Pro Master">
</div>

<div id="loginPage" class="container">
    <div class="balance-card">
        <i class="fas fa-shield-alt" style="font-size:2rem; color:var(--accent)"></i>
        <h3>ACESSO RESTRITO</h3>
        <input id="pass" type="password" placeholder="Senha Administrativa">
        <button onclick="login()">ENTRAR NO PAINEL</button>
    </div>
</div>

<div id="mainPage" class="container" style="display:none">
    <div class="balance-card">
        <h2>Saldo Real (LUCRO LIMPO)</h2>
        <div class="balance-val" id="val-lucro">R$ 0,00</div>
        <div style="display:flex; justify-content:space-around; opacity:0.8; font-size:12px;">
            <span>M√£o de Obra: <b id="val-mao" style="color:var(--accent)">R$ 0</b></span>
            <span>Contas: <b id="val-contas" style="color:var(--danger)">R$ 0</b></span>
            <span>Pe√ßas: <b id="val-pecas" style="color:var(--primary)">R$ 0</b></span>
        </div>
    </div>

    <div class="menu-grid">
        <div class="menu-item" onclick="nav('sec-dash')"><i class="fas fa-chart-line"></i><span>Dash</span></div>
        <div class="menu-item" onclick="nav('sec-serv')"><i class="fas fa-plus"></i><span>Novo</span></div>
        <div class="menu-item" onclick="nav('sec-contas')"><i class="fas fa-receipt"></i><span>Contas</span></div>
        <div class="menu-item" onclick="nav('sec-hist')"><i class="fas fa-search"></i><span>Busca</span></div>
        <div class="menu-item" onclick="nav('sec-oleo')" style="position:relative">
            <i class="fas fa-oil-can"></i><span>√ìleo</span>
            <span id="notif-oleo" class="badge" style="display:none">0</span>
        </div>
        <div class="menu-item" onclick="nav('sec-estoque')"><i class="fas fa-box"></i><span>Estoque</span></div>
        <div class="menu-item" onclick="nav('sec-tabela')"><i class="fas fa-tags"></i><span>Tabela</span></div>
        <div class="menu-item" onclick="nav('sec-taxa')"><i class="fas fa-credit-card"></i><span>Taxas</span></div>
        <div class="menu-item" onclick="nav('sec-agenda')"><i class="fas fa-calendar"></i><span>Agenda</span></div>
        <div class="menu-item" onclick="nav('sec-compras')"><i class="fas fa-cart-plus"></i><span>Compras</span></div>
        <div class="menu-item" onclick="nav('sec-check')"><i class="fas fa-clipboard-list"></i><span>Check</span></div>
        <div class="menu-item" onclick="nav('sec-ia')"><i class="fas fa-brain"></i><span>I.A</span></div>
    </div>
<!-- DASHBOARD FINANCEIRO COMPLETO -->
<div id="sec-dash" class="section active">
    <h3>üìä Resumo Financeiro</h3>
    <canvas id="chartFin" height="200"></canvas>
    <div style="margin-top:10px;">
        <label>Meta de Lucro R$:</label>
        <input id="metaLucro" type="number" placeholder="Ex: 5000">
        <label>Meta de Servi√ßos:</label>
        <input id="metaServ" type="number" placeholder="Ex: 30">
        <label>Meta de Pe√ßas R$:</label>
        <input id="metaPecas" type="number" placeholder="Ex: 2000">
        <button class="btn-success" onclick="renderDashboardMetas()">Atualizar Metas</button>
    </div>
    <div style="margin-top:15px;">
        <button class="btn-success" onclick="gerarPDF()">GERAR RELAT√ìRIO PDF</button>
        <button class="btn-success" onclick="exportCSV()">EXPORTAR CSV/EXCEL</button>
        <button class="btn-danger" onclick="resetMes()">ZERAR DADOS DO M√äS</button>
    </div>
</div>

<!-- NOVO SERVI√áO -->
<div id="sec-serv" class="section">
    <h3>üîß Novo Servi√ßo</h3>
    <input id="sNome" placeholder="Nome do Cliente">
    <input id="sPlaca" placeholder="Placa">
    <input id="sCel" placeholder="Celular (WhatsApp)">
    <input id="sMao" type="number" placeholder="M√£o de Obra (Seu Ganho)">
    <input id="sPec" type="number" placeholder="Pe√ßas (Custo Reposi√ß√£o)">
    <select id="sOleo">
        <option value="nao">Troca de √ìleo? N√£o</option>
        <option value="sim">Troca de √ìleo? Sim (Lembrar em 90 dias)</option>
    </select>
    <button class="btn-success" onclick="salvarServico()">SALVAR SERVI√áO</button>
    <button onclick="zapOrcamento()">ENVIAR OR√áAMENTO (WhatsApp)</button>
</div>

<!-- CONTAS E DESPESAS COM ALERTAS -->
<div id="sec-contas" class="section">
    <h3>üí∏ Contas e Despesas</h3>
    <input id="cDesc" placeholder="Ex: Luz, Aluguel, Almo√ßo">
    <input id="cVal" type="number" placeholder="Valor R$">
    <input id="cData" type="date">
    <select id="cTipo">
        <option value="pix">PIX</option>
        <option value="dinheiro">Dinheiro</option>
        <option value="debito">Cart√£o D√©bito</option>
        <option value="credito">Cart√£o Cr√©dito</option>
    </select>
    <button class="btn-danger" onclick="salvarConta()">PAGAR CONTA</button>
    <div>
        <label>Filtrar Contas:</label>
        <input id="filtroContas" placeholder="Ex: acima de R$ 100" onkeyup="render()">
    </div>
    <div id="lista-contas"></div>
</div>

<!-- HIST√ìRICO DE SERVI√áOS -->
<div id="sec-hist" class="section">
    <h3>üìÇ Hist√≥rico de Servi√ßos</h3>
    <input id="busca" placeholder="Buscar por placa, cliente..." onkeyup="render()">
    <div>
        <label>Filtrar por valor m√≠nimo:</label>
        <input id="filtroLucro" type="number" placeholder="Ex: 200" onkeyup="render()">
    </div>
    <div id="lista-hist"></div>
</div>

<!-- ALERTA DE TROCA DE √ìLEO COM POP-UP -->
<div id="sec-oleo" class="section">
    <h3>üõ¢Ô∏è Lembrete de √ìleo</h3>
    <div id="lista-oleo"></div>
</div>

<!-- ESTOQUE INTELIGENTE COM ALERTAS -->
<div id="sec-estoque" class="section">
    <h3>üì¶ Estoque</h3>
    <input id="eN" placeholder="Pe√ßa">
    <input id="eQ" type="number" placeholder="Quantidade">
    <button onclick="addObj('estoque','eN','eQ')">ADICIONAR</button>
    <label>Alerta m√≠nimo:</label>
    <input id="estoqueAlerta" type="number" placeholder="Ex: 5" onkeyup="render()">
    <div id="l-estoque"></div>
</div>

<!-- TABELA DE PRE√áOS -->
<div id="sec-tabela" class="section">
    <h3>üìã Tabela de Pre√ßos</h3>
    <input id="tN" placeholder="Servi√ßo">
    <input id="tV" placeholder="Valor">
    <button onclick="addObj('tabela','tN','tV')">ADICIONAR</button>
    <div id="l-tabela"></div>
</div>

<!-- CALCULADORA DE TAXAS -->
<div id="sec-taxa" class="section">
    <h3>üí≥ Calculadora de Taxas</h3>
    <input id="taxV" type="number" placeholder="Valor do Servi√ßo">
    <select id="taxTipo">
        <option value="credito">Cart√£o Cr√©dito (+12%)</option>
        <option value="debito">Cart√£o D√©bito (+4%)</option>
        <option value="pix">PIX/Dinheiro (0%)</option>
    </select>
    <button onclick="calcTaxa()">CALCULAR</button>
</div>

<!-- AGENDA COMPLETA COM ALERTAS -->
<div id="sec-agenda" class="section">
    <h3>üìÖ Agenda de Retorno</h3>
    <input id="aN" placeholder="Cliente">
    <input id="aD" type="date">
    <button onclick="addObj('agenda','aN','aD')">AGENDAR</button>
    <div id="l-agenda"></div>
</div>

<!-- LISTA DE COMPRAS -->
<div id="sec-compras" class="section">
    <h3>üõí Lista de Compras</h3>
    <input id="cpN" placeholder="Item faltando">
    <button onclick="addObj('compras','cpN')">ADICIONAR</button>
    <div id="l-compras"></div>
</div>

<!-- CHECK-LIST -->
<div id="sec-check" class="section">
    <h3>üìã Check-list Entrada</h3>
    <input id="chP" placeholder="Placa">
    <textarea id="chD" placeholder="Observa√ß√µes/Avarias"></textarea>
    <button onclick="addObj('check','chP','chD')">SALVAR</button>
    <div id="l-check"></div>
</div>

<!-- I.A ANALISTA + BACKUP -->
<div id="sec-ia" class="section">
    <h3>ü§ñ Analista Inteligente</h3>
    <div id="ia-res" class="ia-box">Aguardando dados...</div>
    <button onclick="analisarIA()">GERAR DIAGN√ìSTICO</button>
    <hr style="opacity:0.1; margin:20px 0">
    <button onclick="gerarBackup()" style="background:#333">GERAR BACKUP</button>
    <textarea id="txtBack" style="font-size:8px"></textarea>
</div>
<script>
/* ================= BANCO DE DADOS ================= */
let db = JSON.parse(localStorage.getItem("lisboa_master")) || {
  mao:0, contas:0, pecas:0,
  servicos:[], despesas:[], estoque:[],
  tabela:[], agenda:[], compras:[], check:[]
};
let chart;

/* ================= LOGIN ================= */
function login(){
  if(pass.value==="1234"){
    loginPage.style.display="none";
    mainPage.style.display="block";
    render();
  } else {
    showPop("Senha errada!", "danger");
  }
}

/* ================= MENU ================= */
function nav(id){
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ================= POP ALERTAS ================= */
function showPop(msg,type="success"){
  let pop=document.getElementById("popAlert");
  pop.className="pop-alert pop-"+type;
  pop.innerText=msg;
  pop.style.display="block";
  setTimeout(()=>pop.style.display="none",4000);
}

/* ================= SALVAR ================= */
function save(){ localStorage.setItem("lisboa_master", JSON.stringify(db)); render(); }

/* ================= SERVI√áOS ================= */
function salvarServico(){
  let m=parseFloat(sMao.value)||0;
  let p=parseFloat(sPec.value)||0;
  if(m+p==0) return;
  db.mao+=m; db.pecas+=p;
  db.servicos.unshift({
    nome:sNome.value, placa:sPlaca.value.toUpperCase(),
    cel:sCel.value, mao:m, pec:p, total:m+p,
    oleo:sOleo.value, data:Date.now()
  });
  showPop("Servi√ßo salvo!");
  sNome.value=sPlaca.value=sCel.value=sMao.value=sPec.value="";
  save();
}

/* ================= CONTAS ================= */
function salvarConta(){
  let v=parseFloat(cVal.value)||0;
  if(v==0) return;
  db.contas+=v;
  db.despesas.unshift({nome:cDesc.value, valor:v, data:cData.value, tipo:cTipo.value});
  showPop("Conta registrada!", "warn");
  cDesc.value=cVal.value="";
  save();
}

/* ================= GEN√âRICO ================= */
function addObj(tipo,id1,id2){
  let obj={nome:document.getElementById(id1).value};
  if(id2) obj.valor=document.getElementById(id2).value;
  db[tipo].push(obj);
  document.getElementById(id1).value="";
  if(id2) document.getElementById(id2).value="";
  save();
}

/* ================= WHATSAPP AUTOM√ÅTICO ================= */
function zapOrcamento(){
  let total=(+sMao.value||0)+(+sPec.value||0);
  let msg=`Ol√°! Or√ßamento Lisboa:\nM√£o de obra: R$${sMao.value}\nPe√ßas: R$${sPec.value}\nTOTAL: R$${total}`;
  window.open(`https://api.whatsapp.com/send?phone=${sCel.value}&text=${encodeURIComponent(msg)}`);
}

function zapPromo(cel){
  let msg="üî• Promo√ß√£o Lisboa Oficina: Revis√£o completa com desconto! Quer agendar?";
  window.open(`https://api.whatsapp.com/send?phone=${cel}&text=${encodeURIComponent(msg)}`);
}

/* ================= TAXAS ================= */
function calcTaxa(){
  let v=parseFloat(taxV.value)||0;
  let tipo=taxTipo.value;
  let total=v;
  if(tipo=="credito") total=v*1.12;
  if(tipo=="debito") total=v*1.04;
  showPop("Cobrar R$ "+total.toFixed(2),"success");
}

/* ================= PDF ================= */
function gerarPDF(){
  const { jsPDF }=window.jspdf;
  let doc=new jsPDF();
  doc.text("RELAT√ìRIO LISBOA MASTER PRO",10,10);
  doc.text(`Lucro: R$ ${db.mao-db.contas}`,10,20);
  doc.save("relatorio.pdf");
}

/* ================= CSV / EXCEL ================= */
function exportCSV(){
  let csv="Tipo,Nome,Valor,Data\n";
  db.servicos.forEach(s=>csv+=`Servi√ßo,${s.nome},${s.total},${new Date(s.data).toLocaleDateString()}\n`);
  db.despesas.forEach(d=>csv+=`Despesa,${d.nome},${d.valor},${d.data}\n`);
  db.estoque.forEach(e=>csv+=`Estoque,${e.nome},${e.valor},-\n`);
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="lisboa.csv";
  a.click();
}

/* ================= BACKUP ================= */
function gerarBackup(){ txtBack.value=btoa(JSON.stringify(db)); }

/* ================= DASHBOARD METAS ================= */
function renderDashboardMetas(){
  let lucro=db.mao-db.contas;
  if(metaLucro.value && lucro<metaLucro.value) showPop("Meta de lucro N√ÉO atingida","warn");
}

/* ================= ALERTAS AUTOM√ÅTICOS ================= */
function checarAlertas(){
  let hoje=Date.now();
  let vencidos=0;

  // √ìleo vencido
  db.servicos.forEach(s=>{
    if(s.oleo=="sim"){
      let dias=(hoje-s.data)/(1000*60*60*24);
      if(dias>90) vencidos++;
    }
  });
  notif-oleo.innerText=vencidos;
  notif-oleo.style.display=vencidos? "block":"none";
  if(vencidos>0) showPop("‚ö† Trocas de √≥leo vencidas!","danger");

  // Estoque baixo
  let min=parseInt(estoqueAlerta.value)||5;
  let baixo=db.estoque.filter(e=>(+e.valor||0)<min);
  if(baixo.length) showPop("‚ö† Estoque baixo!","warn");

  // Contas altas
  if(db.contas>db.mao) showPop("üö® Contas maiores que lucro!","danger");
}

/* ================= RENDER ================= */
function render(){
  let lucro=db.mao-db.contas;
  val-lucro.innerText="R$ "+lucro.toFixed(2);
  val-mao.innerText="R$ "+db.mao.toFixed(2);
  val-contas.innerText="R$ "+db.contas.toFixed(2);
  val-pecas.innerText="R$ "+db.pecas.toFixed(2);

  // HIST√ìRICO
  lista-hist.innerHTML=db.servicos.map(s=>
    `<div class="list-item"><span>${s.placa} - ${s.nome}</span><b>R$${s.total}</b></div>`
  ).join("");

  // CONTAS
  lista-contas.innerHTML=db.despesas.map(d=>
    `<div class="list-item" style="border-left-color:red"><span>${d.nome}</span><b>-R$${d.valor}</b></div>`
  ).join("");

  // ESTOQUE
  l-estoque.innerHTML=db.estoque.map(e=>{
    let min=parseInt(estoqueAlerta.value)||5;
    let cor=(+e.valor<min)?"red":"#00d2ff";
    return `<div class="list-item" style="border-left-color:${cor}"><span>${e.nome}</span><b>${e.valor}</b></div>`;
  }).join("");

  // GR√ÅFICO PRINCIPAL
  let ctx=document.getElementById("chartFin").getContext("2d");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Lucro","Contas","Pe√ßas"],
      datasets:[{data:[lucro,db.contas,db.pecas],backgroundColor:["#00f298","#ff4b5c","#00d2ff"]}]
    },
    options:{responsive:true}
  });

  checarAlertas();
}

/* ================= RESET M√äS ================= */
function resetMes(){
  if(confirm("Zerar m√™s?")){
    db.mao=db.contas=db.pecas=0;
    save();
  }
}

/* ================= AUTO START ================= */
render();
</script>
</body>
</html>
