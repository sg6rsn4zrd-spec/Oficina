<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LISBOA PRO 2.1</title>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
    --bg: #0a0e17;
    --card: #161b28;
    --primary: #2a5ee8;
    --accent: #00d2ff;
    --success: #00f298;
    --danger: #ff4b5c;
    --text: #e1e8f0;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background:var(--bg);color:var(--text);padding-bottom:80px;}
.header{background:var(--card);padding:20px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.1);}
.header img{max-width:130px;}
.container{padding:15px;max-width:700px;margin:auto;}

/* Cards Dashboard */
.balance-card{background:linear-gradient(135deg,#1e2a4a,#161b28);padding:25px;border-radius:24px;text-align:center;margin-bottom:20px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 10px 30px rgba(0,0,0,0.3);}
.balance-card h2{margin:0;font-size:0.9rem;text-transform:uppercase;opacity:0.7;}
.balance-val{font-size:2.5rem;font-weight:800;color:var(--success);margin:10px 0;}

/* Menu Grid */
.menu-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:25px;}
.menu-item{background:var(--card);padding:12px 5px;border-radius:16px;text-align:center;border:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:0.2s;}
.menu-item i{font-size:1.2rem;color:var(--accent);margin-bottom:6px;display:block;}
.menu-item span{font-size:0.55rem;font-weight:700;text-transform:uppercase;}
.menu-item:hover{transform:translateY(-2px);background:rgba(42,94,232,0.2);}
.menu-item:active{transform:scale(0.95);background:var(--primary);}

/* Se√ß√µes */
.section{background:var(--card);padding:20px;border-radius:24px;display:none;border:1px solid rgba(255,255,255,0.05);}
.active{display:block;animation:slideIn 0.3s ease-out;}
@keyframes slideIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* Inputs e Bot√µes */
input, select, textarea{background:#0f141e;border:1px solid #2d364a;color:white;padding:14px;border-radius:12px;width:100%;margin:8px 0;font-size:15px;}
button{background:var(--primary);color:white;padding:16px;border-radius:14px;border:none;font-weight:700;width:100%;cursor:pointer;margin-top:10px;font-size:14px;transition:0.2s;}
button:active{opacity:0.8;}
.btn-success{background:var(--success);color:#0a0e17;}
.btn-danger{background:var(--danger);}

/* Listas */
.list-item{background:rgba(255,255,255,0.03);padding:15px;border-radius:16px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid var(--primary);}
.badge{background:var(--danger);color:white;border-radius:50px;padding:2px 8px;font-size:10px;position:absolute;top:-5px;right:-5px;}

/* IA Box */
.ia-box{background:#000;border:1px solid var(--success);padding:15px;border-radius:12px;font-family:'Courier New',monospace;color:var(--success);font-size:13px;line-height:1.4;}

/* Toaster */
.toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#000;padding:12px 20px;border-radius:12px;box-shadow:0 5px 15px rgba(0,0,0,0.3);opacity:0;pointer-events:none;transition:0.5s;}
.toast.show{opacity:1;pointer-events:auto;}
</style>
</head>
<body>

<div class="header">
    <img src="B1BCC237-7C89-4142-8131-6DA05C2A2C61 2.png" alt="Lisboa Pro">
</div>

<!-- Login -->
<div id="loginPage" class="container">
    <div class="balance-card">
        <i class="fas fa-shield-alt" style="font-size:2rem;color:var(--accent);"></i>
        <h3>ACESSO RESTRITO</h3>
        <input id="pass" type="password" placeholder="Senha Administrativa">
        <button onclick="login()">ENTRAR NO PAINEL</button>
    </div>
</div>

<!-- Painel Principal -->
<div id="mainPage" class="container" style="display:none">

    <!-- Resumo -->
    <div class="balance-card">
        <h2>Saldo Real (Lucro L√≠quido)</h2>
        <div class="balance-val" id="val-lucro">R$ 0,00</div>
        <div style="display:flex;justify-content:space-around;opacity:0.8;font-size:12px;">
            <span>M√£o de Obra: <b id="val-mao" style="color:var(--accent)">R$ 0</b></span>
            <span>Contas: <b id="val-contas" style="color:var(--danger)">R$ 0</b></span>
        </div>
    </div>

    <!-- Menu -->
    <div class="menu-grid">
        <div class="menu-item" onclick="nav('sec-dash')"><i class="fas fa-chart-line"></i><span>Dash</span></div>
        <div class="menu-item" onclick="nav('sec-serv')"><i class="fas fa-plus"></i><span>Novo</span></div>
        <div class="menu-item" onclick="nav('sec-contas')"><i class="fas fa-receipt"></i><span>Contas</span></div>
        <div class="menu-item" onclick="nav('sec-hist')"><i class="fas fa-search"></i><span>Busca</span></div>
        <div class="menu-item" onclick="nav('sec-oleo')" style="position:relative">
            <i class="fas fa-oil-can"></i><span>√ìleo</span>
            <span id="notif-oleo" class="badge" style="display:none">0</span>
        </div>
        <div class="menu-item" onclick="nav('sec-estoque')"><i class="fas fa-box"></i><span>Estoque</span></div>
        <div class="menu-item" onclick="nav('sec-tabela')"><i class="fas fa-tags"></i><span>Tabela</span></div>
        <div class="menu-item" onclick="nav('sec-taxa')"><i class="fas fa-credit-card"></i><span>Taxas</span></div>
        <div class="menu-item" onclick="nav('sec-agenda')"><i class="fas fa-calendar"></i><span>Agenda</span></div>
        <div class="menu-item" onclick="nav('sec-compras')"><i class="fas fa-cart-plus"></i><span>Compras</span></div>
        <div class="menu-item" onclick="nav('sec-check')"><i class="fas fa-clipboard-list"></i><span>Check</span></div>
        <div class="menu-item" onclick="nav('sec-ia')"><i class="fas fa-brain"></i><span>I.A</span></div>
    </div>

    <!-- DASHBOARD -->
    <div id="sec-dash" class="section active">
        <h3>üìä Resumo Financeiro</h3>
        <canvas id="chartFin" height="200"></canvas>
        <button class="btn-success" onclick="gerarPDF()"><i class="fas fa-file-pdf"></i> GERAR RELAT√ìRIO</button>
        <button class="btn-danger" onclick="resetMes()">ZERAR DADOS DO M√äS</button>
    </div>

    <!-- NOVO SERVI√áO -->
    <div id="sec-serv" class="section">
        <h3>üîß Novo Servi√ßo</h3>
        <input id="sNome" placeholder="Nome do Cliente">
        <input id="sPlaca" placeholder="Placa">
        <input id="sCel" placeholder="Celular (WhatsApp)">
        <input id="sMao" type="number" placeholder="M√£o de Obra">
        <input id="sPec" type="number" placeholder="Pe√ßas">
        <select id="sOleo">
            <option value="nao">Troca de √ìleo? N√£o</option>
            <option value="sim">Troca de √ìleo? Sim (90 dias)</option>
        </select>
        <button class="btn-success" onclick="salvarServico()">SALVAR SERVI√áO</button>
        <button onclick="zapOrcamento()">ENVIAR OR√áAMENTO (WhatsApp)</button>
    </div>

    <!-- CONTAS -->
    <div id="sec-contas" class="section">
        <h3>üí∏ Contas e Despesas</h3>
        <input id="cDesc" placeholder="Ex: Luz, Aluguel, Almo√ßo">
        <input id="cVal" type="number" placeholder="Valor R$">
        <button class="btn-danger" onclick="salvarConta()">PAGAR CONTA</button>
        <div id="lista-contas"></div>
    </div>

    <!-- √ìLEO -->
    <div id="sec-oleo" class="section">
        <h3>üõ¢Ô∏è Lembrete de √ìleo</h3>
        <div id="lista-oleo"></div>
    </div>

    <!-- HIST√ìRICO -->
    <div id="sec-hist" class="section">
        <h3>üìÇ Hist√≥rico</h3>
        <input id="busca" placeholder="Buscar por placa..." onkeyup="render()">
        <div id="lista-hist"></div>
    </div>

    <!-- IA / ANALISTA -->
    <div id="sec-ia" class="section">
        <h3>ü§ñ Analista Inteligente</h3>
        <div id="ia-res" class="ia-box">Aguardando dados...</div>
        <button onclick="analisarIA()">GERAR DIAGN√ìSTICO</button>
        <hr style="opacity:0.1;margin:20px 0">
        <button onclick="gerarBackup()" style="background:#333">GERAR BACKUP</button>
        <textarea id="txtBack" style="font-size:8px;width:100%;height:60px;"></textarea>
    </div>

</div>

<!-- Toaster -->
<div id="toast" class="toast"></div>

<script>
/* ================= VARI√ÅVEIS ================= */
const loginPage = document.getElementById('loginPage');
const mainPage = document.getElementById('mainPage');

const sNome = document.getElementById('sNome');
const sPlaca = document.getElementById('sPlaca');
const sMao = document.getElementById('sMao');
const sPec = document.getElementById('sPec');
const sCel = document.getElementById('sCel');
const sOleo = document.getElementById('sOleo');

const cVal = document.getElementById('cVal');
const cDesc = document.getElementById('cDesc');

const busca = document.getElementById('busca');
const txtBack = document.getElementById('txtBack');

const toastDiv = document.getElementById('toast');

let chart;

/* ================= BANCO DE DADOS ================= */
let db = JSON.parse(localStorage.getItem('lisboa_vfinal')) || {
    mao:0, contas:0, pecas:0,
    servicos:[], despesas:[],
    estoque:[], tabela:[],
    agenda:[], compras:[], check:[]
};

function save(){
    localStorage.setItem('lisboa_vfinal', JSON.stringify(db));
    render();
}

function showToast(msg){
    toastDiv.innerText = msg;
    toastDiv.classList.add('show');
    setTimeout(()=>{toastDiv.classList.remove('show');},2000);
}

/* ================= LOGIN ================= */
function login(){
    const senha = document.getElementById('pass').value;
    if(senha === '1234'){
        loginPage.style.display='none';
        mainPage.style.display='block';
        render();
    } else showToast("Senha incorreta!");
}

/* ================= NAVEGA√á√ÉO ================= */
function nav(id){
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

/* ================= SERVI√áO ================= */
function salvarServico(){
    let m=parseFloat(sMao.value)||0;
    let p=parseFloat(sPec.value)||0;
    if(m+p>0){
        db.mao+=m; db.pecas+=p;
        db.servicos.unshift({
            n:sNome.value||"Sem nome",
            p:sPlaca.value.toUpperCase()||"SEMPLACA",
            v:m+p,
            m:m,
            pe:p,
            z:sCel.value||"",
            ol:sOleo.value||"nao",
            d:new Date().getTime()
        });
        sNome.value=sPlaca.value=sMao.value=sPec.value=sCel.value="";
        save();
        showToast("Servi√ßo salvo!");
    } else showToast("Digite valores v√°lidos.");
}

/* ================= CONTAS ================= */
function salvarConta(){
    let v=parseFloat(cVal.value)||0;
    if(v>0){
        db.contas+=v;
        db.despesas.unshift({n:cDesc.value||"Sem descri√ß√£o",v:v,d:new Date().toLocaleDateString()});
        cVal.value=cDesc.value="";
        save();
        showToast("Conta registrada!");
    } else showToast("Valor inv√°lido.");
}

/* ================= RENDER ================= */
function render(){
    let lucro=db.mao-db.contas;
    document.getElementById('val-lucro').innerText="R$ "+lucro.toFixed(2);
    document.getElementById('val-mao').innerText="R$ "+db.mao.toFixed(2);
    document.getElementById('val-contas').innerText="R$ "+db.contas.toFixed(2);

    // Hist√≥rico
    document.getElementById('lista-hist').innerHTML=db.servicos
        .filter(s=>s.p.includes(busca.value.toUpperCase()))
        .map(s=>`<div class="list-item"><span><b>${s.p}</b> - ${s.n}</span><b>R$ ${s.v}</b></div>`).join('');

    // Contas
    document.getElementById('lista-contas').innerHTML=db.despesas
        .map(d=>`<div class="list-item"><span>${d.n}</span><b style="color:red">- R$ ${d.v}</b></div>`).join('');

    // √ìleo
    let hoje=new Date().getTime();
    let vencidos=0;
    let htmlOleo="";
    db.servicos.forEach(s=>{
        if(s.ol==="sim"){
            let dias=Math.floor((hoje-s.d)/(1000*60*60*24));
            if(dias>=90){
                vencidos++;
                htmlOleo+=`<div class="list-item" style="border-left-color:red">
                <span>${s.p} - ${s.n} (${dias} dias)</span>
                <i class="fab fa-whatsapp" onclick="window.open('https://api.whatsapp.com/send?phone=${encodeURIComponent(s.z.replace(/\D/g,''))}&text=${encodeURIComponent('Ol√°! J√° faz 3 meses da √∫ltima troca de √≥leo. Vamos agendar?')}')"></i>
                </div>`;
            }
        }
    });
    document.getElementById('notif-oleo').innerText=vencidos;
    document.getElementById('notif-oleo').style.display=vencidos>0?'block':'none';
    document.getElementById('lista-oleo').innerHTML=htmlOleo||"Sem trocas pendentes.";

    // Gr√°fico
    const ctx=document.getElementById('chartFin').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
        type:'doughnut',
        data:{
            labels:['Lucro L√≠quido','Contas','Pe√ßas'],
            datasets:[{
                data:[lucro>0?lucro:0,db.contas,db.pecas],
                backgroundColor:['#00f298','#ff4b5c','#00d2ff'],
                borderWidth:0
           
